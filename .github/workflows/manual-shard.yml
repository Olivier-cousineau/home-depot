name: Manual shard runner

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action à exécuter"
        required: true
        type: choice
        options:
          - create_shards
          - run_shard
      shard:
        description: "ID du shard à lancer (requis pour run_shard)"
        required: false
        default: "1"
      stores_per_shard:
        description: "Nombre de magasins par shard (utilisé lors de la création)"
        required: false
        default: "8"

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      MAX_MINUTES_PER_STORE: "25"
      MAX_CONCURRENCY: "4"
      VERBOSE: "1"
      SAFE_MODE: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Validate inputs
        run: |
          if [ "${{ inputs.action }}" = "run_shard" ] && [ -z "${{ inputs.shard }}" ]; then
            echo "Un shard_id est requis pour l'action run_shard"
            exit 1
          fi

      - name: Run scraper action
        run: |
          case "${{ inputs.action }}" in
            create_shards)
              python home_depot_scraper.py --create-shards --stores-per-shard "${{ inputs.stores_per_shard }}"
              ;;
            run_shard)
              python home_depot_scraper.py run_shard --shard "${{ inputs.shard }}"
              ;;
            *)
              echo "Action inconnue: ${{ inputs.action }}"
              exit 1
              ;;
          esac

      - name: Commit & push shards
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add shards/ || true
          git status --porcelain
          git commit -m "chore(home-depot): update store shards" || true
          git push || true

      - name: Upload shards manifest
        if: inputs.action == 'create_shards'
        uses: actions/upload-artifact@v4
        with:
          name: shards
          path: |
            shards/**/*.json
          if-no-files-found: warn

      - name: Upload shard results
        if: inputs.action == 'run_shard'
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ inputs.shard }}-results
          path: |
            results/shard_${{ inputs.shard }}_results.*
          if-no-files-found: warn
